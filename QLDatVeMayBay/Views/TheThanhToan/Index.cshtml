@model QLDatVeMayBay.Models.ViewModels.TheThanhToanViewModel
@using QLDatVeMayBay.Models.Entities;

@{
    ViewData["Title"] = "Thẻ của tôi";
}

@if (TempData["Debug"] != null)
{
    <div class="alert alert-danger">@TempData["Debug"]</div>
}

<div class="container mt-4">
    <h2 class="fw-bold mb-4">@ViewData["Title"]</h2>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success">@TempData["Success"]</div>
    }

    <div class="row">
        <!-- 🔹 Cột trái: Hiển thị thông tin nếu có -->
        <div class="col-md-6">
            @if (Model.Loai == LoaiTheLoaiVi.TheNganHang)
            {
                <div class="card border-primary mb-3">
                    <div class="card-header bg-primary text-white">Thông tin thẻ ngân hàng</div>
                    <div class="card-body">
                        <p><strong>Số thẻ:</strong> @Model.SoThe</p>
                        <p><strong>Tên in trên thẻ:</strong> @Model.TenTrenThe</p>
                        <p><strong>Hiệu lực:</strong> @Model.HieuLuc</p>
                        <p><strong>CVV:</strong> @Model.CVV</p>
                    </div>
                </div>
            }
            else if (Model.Loai == LoaiTheLoaiVi.ViDienTu)
            {
                <div class="card border-success mb-3">
                    <div class="card-header bg-success text-white">Thông tin ví điện tử</div>
                    <div class="card-body">
                        <p><strong>Tên ví:</strong> @Model.TenVi</p>
                        <p><strong>Email:</strong> @Model.EmailLienKet</p>
                        <p><strong>SĐT:</strong> @Model.SoDienThoai</p>
                        <p><strong>Ngày liên kết:</strong> @Model.NgayLienKet?.ToString("dd/MM/yyyy")</p>
                    </div>
                </div>
            }
        </div>

        <!-- 🔸 Cột phải: Form thêm mới -->
        <div class="col-md-6">
            <div class="card mb-4 @(Model.Loai == null ? "d-none" : "")">
                <div class="card-body">
                    <form method="post" asp-action="@(Model.Loai == LoaiTheLoaiVi.ViDienTu ? "CreateViDienTu" : "CreateTheNganHang")">
                        @if (Model.Loai == LoaiTheLoaiVi.TheNganHang)
                        {
                            <h5 class="mb-3">Thêm thẻ ngân hàng</h5>
                            <div class="mb-3">
                                <label class="form-label">Số thẻ</label>
                                <input asp-for="SoThe" class="form-control" />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Tên in trên thẻ</label>
                                <input asp-for="TenTrenThe" class="form-control" />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Hiệu lực (MM/yyyy)</label>
                                <input asp-for="HieuLuc" class="form-control" />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">CVV</label>
                                <input asp-for="CVV" class="form-control" />
                            </div>
                        }
                        else if (Model.Loai == LoaiTheLoaiVi.ViDienTu)
                        {
                            <h5 class="mb-3">Thêm ví điện tử</h5>
                            <div class="mb-3">
                                <label class="form-label">Tên ví</label>
                                <input asp-for="TenVi" class="form-control" />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Email liên kết</label>
                                <input asp-for="EmailLienKet" class="form-control" />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Tên hiển thị</label>
                                <input asp-for="TenHienThi" class="form-control" />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Số điện thoại</label>
                                <input asp-for="SoDienThoai" class="form-control" />
                            </div>
                        }
                        <button type="submit" class="btn btn-primary">Lưu</button>
                    </form>
                </div>
            </div>

            <div class="d-flex gap-3">
                <button id="btn-show-the" class="btn btn-outline-primary">
                    <i class="bi bi-credit-card-2-front me-1"></i> Thêm thẻ ngân hàng
                </button>
                <button id="btn-show-vi" class="btn btn-outline-success">
                    <i class="bi bi-wallet2 me-1"></i> Thêm ví điện tử
                </button>
            </div>
        </div>
    </div>

    <hr />

    <!-- 📋 Danh sách thẻ và ví đã thêm -->
    @if (!Model.DanhSach.Any())
    {
        <div class="alert alert-info text-center rounded-3 p-4 shadow-sm border">
            Bạn chưa thêm thẻ hoặc ví nào.
        </div>
    }
    else
    {
        <h4 class="mt-4 mb-3">Danh sách thẻ và ví</h4>
        <div class="row">
            @foreach (var item in Model.DanhSach)
            {
                <div class="col-md-4 mb-4">
                    <div class="card border shadow-sm h-100">
                        <div class="card-body">
                            @if (item.Loai == LoaiTheLoaiVi.TheNganHang)
                            {
                                <p><strong>Số thẻ:</strong> @item.SoThe</p>
                                <p><strong>Tên in trên thẻ:</strong> @item.TenTrenThe</p>
                                <p><strong>Hiệu lực:</strong> @item.HieuLuc</p>
                            }
                            else if (item.Loai == LoaiTheLoaiVi.ViDienTu)
                            {
                                <p><strong>Tên ví:</strong> @item.TenVi</p>
                                <p><strong>Email liên kết:</strong> @item.EmailLienKet</p>
                                <p><strong>Số điện thoại:</strong> @item.SoDienThoai</p>
                            }
                            <p><strong>Ngày liên kết:</strong> @item.NgayLienKet?.ToString("dd/MM/yyyy")</p>
                        </div>
                        <div class="card-footer d-flex justify-content-between">
                            <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-sm btn-warning">
                                <i class="bi bi-pencil-square"></i> Sửa
                            </a>
                            <a href="#" class="btn btn-sm btn-danger btn-xoa" data-url="@Url.Action("Delete", "TheThanhToan", new { id = item.Id })">
                                <i class="bi bi-trash"></i> Xoá
                            </a>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        document.querySelectorAll('.btn-xoa').forEach(button => {
            button.addEventListener('click', function (e) {
                e.preventDefault();
                const url = this.getAttribute('data-url');
                Swal.fire({
                    title: 'Bạn có chắc chắn muốn xoá?',
                    text: "Thao tác này không thể hoàn tác!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Xoá',
                    cancelButtonText: 'Huỷ'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = url;
                    }
                });
            });
        });

        const btnShowThe = document.getElementById("btn-show-the");
        const btnShowVi = document.getElementById("btn-show-vi");

        btnShowThe?.addEventListener("click", function (e) {
            e.preventDefault();
            window.location.href = '@Url.Action("Index", "TheThanhToan")?showForm=The';
        });

        btnShowVi?.addEventListener("click", function (e) {
            e.preventDefault();
            window.location.href = '@Url.Action("Index", "TheThanhToan")?showForm=Vi';
        });
    </script>
}
