@model List<QLDatVeMayBay.Models.NguoiDung>
@{
    var tuKhoa = ViewBag.TuKhoa as string ?? "";
    var page = (int)ViewBag.Page;
    var totalPages = (int)ViewBag.TotalPages;

    var trangThai = ViewBag.TrangThai as string ?? "";
    var vaiTro = ViewBag.VaiTro as string ?? "";

    var selectedTrangThaiHoatDong = trangThai == "HoatDong" ? "selected" : "";
    var selectedTrangThaiBiKhoa = trangThai == "BiKhoa" ? "selected" : "";

    var selectedVaiTroAdmin = vaiTro == "Admin" ? "selected" : "";
    var selectedVaiTroKhachHang = vaiTro == "KhachHang" ? "selected" : "";
}
@{
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}
<h2 class="mt-3">👥 Quản lý người dùng</h2>

<form method="get" class="row g-3 mb-3">
    <!-- Ô nhập từ khóa -->
    <div class="col-md-3">
        <input type="text" name="tuKhoa" class="form-control"
               placeholder="Tìm theo tên, email, SĐT" value="@ViewBag.TuKhoa" />
    </div>

    <!-- Chọn Trạng thái -->
<div class="col-md-3">
    <select name="trangThai" class="form-select">
        <option value="">-- Tất cả trạng thái --</option>
        <option value="HoatDong" @selectedTrangThaiHoatDong>🟢 Hoạt động</option>
        <option value="BiKhoa" @selectedTrangThaiBiKhoa>🔴 Bị khóa</option>
    </select>
</div>

    <<!-- Chọn Vai trò -->
<div class="col-md-3">
    <select name="vaiTro" class="form-select">
        <option value="">-- Tất cả vai trò --</option>
        <option value="Admin" @selectedVaiTroAdmin>🛡️ Admin</option>
        <option value="KhachHang" @selectedVaiTroKhachHang>👤 Khách hàng</option>
    </select>
</div>

    <!-- Các nút chức năng -->
    <div class="col-md-auto">
        <button type="submit" class="btn btn-primary">🔍 Tìm kiếm</button>
        <a href="/NguoiDung/Index" class="btn btn-secondary">🔄 Làm mới</a>
        <a href="/NguoiDung/XuatExcel?tuKhoa=@ViewBag.TuKhoa&trangThai=@ViewBag.TrangThai&vaiTro=@ViewBag.VaiTro"
           class="btn btn-success">
            📄 Xuất Excel
        </a>
    </div>
</form>



<table class="table table-bordered table-hover">
    <thead class="table-light">
        <tr>
            <th>Tài khoản</th>
            <th>Họ tên</th>
            <th>Email</th>
            <th>SĐT</th>
            <th>Giới tính</th>
            <th>Trạng thái</th>
            <th class="text-center">Hành động</th>
        </tr>
    </thead>
    <tbody>
        @if (!Model.Any())
        {
            <tr><td colspan="7" class="text-center">Không có người dùng nào.</td></tr>
        }
        else
        {
            foreach (var n in Model)
            {
                var trangThai = n.TaiKhoan?.TrangThaiTK ?? "Không xác định";
                <tr>
                    <td>@n.TenDangNhap</td>
                    <td>@n.HoTen</td>
                    <td>@n.Email</td>
                    <td>@n.SoDienThoai</td>
                    <td>@n.GioiTinh</td>
                    <td>
                        <span class="badge @(trangThai == "HoatDong" ? "bg-success" : "bg-danger")">
                            @(trangThai == "HoatDong" ? "Hoạt động" : "Bị khóa")
                        </span>
                    </td>
                    <td class="text-center">
                        <a href="/NguoiDung/ChiTiet?tenDangNhap=@n.TenDangNhap" class="btn btn-sm btn-info">🔎 Xem</a>

                        <form asp-action="DoiTrangThai" method="post" class="d-inline">
                            <input type="hidden" name="tenDangNhap" value="@n.TenDangNhap" />
                            <button type="submit" class="btn btn-sm btn-warning">🔁 Đổi trạng thái</button>
                        </form>

                        <a href="/NguoiDung/XacNhanXoa?tenDangNhap=@n.TenDangNhap" class="btn btn-sm btn-danger">🗑 Xoá</a>

                    </td>
                </tr>
            }
        }
    </tbody>
</table>

@if (totalPages > 1)
{
    <nav aria-label="Phân trang người dùng">
        <ul class="pagination justify-content-center">

            <!-- Nút trang trước -->
            <li class="page-item @(page <= 1 ? "disabled" : "")">
                <a class="page-link"
                   href="?tuKhoa=@ViewBag.TuKhoa&trangThai=@ViewBag.TrangThai&vaiTro=@ViewBag.VaiTro&page=@(page - 1)">
                    ←
                </a>
            </li>

            <!-- Các số trang -->
            @for (int i = 1; i <= totalPages; i++)
            {
                <li class="page-item @(i == page ? "active" : "")">
                    <a class="page-link"
                       href="?tuKhoa=@ViewBag.TuKhoa&trangThai=@ViewBag.TrangThai&vaiTro=@ViewBag.VaiTro&page=@i">
                        @i
                    </a>
                </li>
            }

            <!-- Nút trang sau -->
            <li class="page-item @(page >= totalPages ? "disabled" : "")">
                <a class="page-link"
                   href="?tuKhoa=@ViewBag.TuKhoa&trangThai=@ViewBag.TrangThai&vaiTro=@ViewBag.VaiTro&page=@(page + 1)">
                    →
                </a>
            </li>
        </ul>
    </nav>
}

